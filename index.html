<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Free Text-to-Speech Reader | Convert Text to Speech Online</title>
  <meta name="description" content="Convert any text to speech instantly with our free, no-sign-up tool. Multiple languages, natural voices, and simple controls. Start reading aloud now!">
  <link rel="stylesheet" href="styles.css">
  <!-- Adsense script (unchanged) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4003447295960802"
    crossorigin="anonymous"></script>
  <meta name="google-site-verification" content="ndECWtgXIkiPKk8wKFXTkCd2JSwMnWBKZ4H2uOtQpjY" />
  <!-- Google Tag Manager (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SVGML1VGPG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SVGML1VGPG');
  </script>
  <!-- Optional: Insert JSON‑LD structured data here for FAQ or WebApplication schema -->
</head>
<body>
  <!-- HEADER: Logo & Navigation -->
  <header>
    <div class="container">
      <div class="logo">Read-Aloud</div>
      <nav>
        <ul>
          <li><a href="#hero">Home</a></li>
          <li><a href="#about">About</a></li>
          <li><a href="#how-it-works">How It Works</a></li>
          <li><a href="#faq">FAQ</a></li>
          <li><a href="#blog">Blog</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- HERO SECTION: Eye-catching introduction and AdSense container -->
  <section id="hero">
    <div class="container">
      <h1>Free Text-to-Speech Reader</h1>
      <p>Convert any text into natural-sounding speech instantly—no sign-up, unlimited usage!</p>
      <a href="#tool-interface" class="btn">Try It Now</a>
      <!-- Google AdSense Ad Container (retained near the top) -->
      <div class="ad-container" style="margin: 20px 0;">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4003447295960802"
             data-ad-slot="YOUR_AD_SLOT"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
    </div>
  </section>

  <!-- ABOUT SECTION -->
  <section id="about">
    <div class="container">
      <h2>About This Tool</h2>
      <p>
        Our free text-to-speech tool is designed to help you convert written text into natural, easy-to-listen speech. Perfect for accessibility, studying, and multitasking—no downloads or sign-ups required.
      </p>
    </div>
  </section>

  <!-- TOOL INTERFACE SECTION: The core functionality -->
  <section id="tool-interface">
    <div class="container">
      <h2>Try It Out</h2>
      <textarea id="textInput" placeholder="Type or paste your text here..."></textarea>
      <br>
      <label for="languageSelect">Select Language:</label>
      <select id="languageSelect" onchange="filterVoicesByLanguage()">
        <option value="en" selected>English</option>
        <option value="es">Spanish</option>
        <option value="fr">French</option>
        <option value="de">German</option>
        <option value="it">Italian</option>
      </select>
      <br>
      <label for="voiceSelect">Select Voice:</label>
      <select id="voiceSelect">
        <option value="-1">Default Voice (Fallback)</option>
      </select>
      <br>
      <label for="rateControl">Reading Speed:</label>
      <input type="range" id="rateControl" min="0.5" max="2" step="0.1" value="1" onchange="updateRate(this.value)">
      <span id="rateValue">1</span>
      <div class="button-container">
        <button onclick="startReading(true)">Start</button>
        <button onclick="pauseReading()">Pause</button>
        <button onclick="resumeReading()">Resume</button>
        <button onclick="stopReading()">Stop</button>
      </div>
      <div id="textDisplay"></div>
      <div id="progressContainer">
        <div class="progress-details">
          <p><strong>Progress:</strong> <span id="progressPercent">0%</span></p>
          <p><strong>Time Elapsed:</strong> <span id="timeElapsed">00:00:00</span></p>
          <p><strong>Time Remaining:</strong> <span id="timeRemaining">00:00:00</span></p>
        </div>
      </div>
    </div>
  </section>

  <!-- BENEFITS/USE-CASES SECTION -->
  <section id="benefits">
    <div class="container">
      <h2>Why Use Our Tool?</h2>
      <div class="benefit">
        <h3>Accessibility</h3>
        <p>Listen to text if you have visual impairments or dyslexia.</p>
      </div>
      <div class="benefit">
        <h3>Productivity</h3>
        <p>Convert emails, articles, and reports to audio on the go.</p>
      </div>
      <div class="benefit">
        <h3>Learning</h3>
        <p>Enhance your studies by listening to your notes or foreign language texts.</p>
      </div>
    </div>
  </section>

  <!-- HOW IT WORKS & FAQ SECTION -->
  <section id="how-it-works">
    <div class="container">
      <h2>How It Works</h2>
      <p>
        Simply paste your text into the area above, select your language and voice, adjust the reading speed, and click “Start.” Enjoy real-time word highlighting and progress tracking as your text is read aloud.
      </p>
      <!-- FAQ integrated within the same section for simplicity -->
      <h2>Frequently Asked Questions</h2>
      <details>
        <summary>Is this tool free?</summary>
        <p>Yes, it’s completely free with no sign-ups or downloads.</p>
      </details>
      <details>
        <summary>Can I use it for accessibility?</summary>
        <p>Absolutely! It’s designed for users with visual impairments and dyslexia.</p>
      </details>
      <details>
        <summary>What languages are supported?</summary>
        <p>We currently support English, Spanish, French, German, and Italian.</p>
      </details>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="container">
      <p>&copy; 2025 Read-Aloud.com. All rights reserved.</p>
      <nav>
        <ul>
          <li><a href="/privacy">Privacy Policy</a></li>
          <li><a href="/terms">Terms of Use</a></li>
          <li><a href="/contact">Contact</a></li>
        </ul>
      </nav>
    </div>
  </footer>

  <!-- ==================== JavaScript Code ==================== -->
  <script>
    /* -----------------------------------------------------------
       CONFIG: Toggle fallback usage ON/OFF
       ----------------------------------------------------------- */
    const useVoiceRSSFallback = true; // Set to true to enable fallback

    /* -----------------------------------------------------------
       GLOBAL VARIABLES
       ----------------------------------------------------------- */
    let speechSynthesisUtterance;
    let voices = [];
    let startWordIndex = 0;
    let previousText = "";
    let readingStartTime = null;
    let cachedSpans = null; // Cache spans for performance optimization

    const textDisplay = document.getElementById('textDisplay');
    const textInput = document.getElementById('textInput');
    const voicesDropdown = document.getElementById('voiceSelect');
    const languageDropdown = document.getElementById('languageSelect');
    const rateControl = document.getElementById('rateControl');
    const rateValue = document.getElementById('rateValue');

    const progressPercent = document.getElementById('progressPercent');
    const timeElapsed = document.getElementById('timeElapsed');
    const timeRemaining = document.getElementById('timeRemaining');

    const regionalVoicePriority = {
      "en-US": ["Samantha", "Alex"],
      "en-GB": ["Daniel", "Serena", "Moira"],
      "en-AU": ["Karen", "Russell"],
      "fr-FR": ["Thomas", "Audrey"],
      "de-DE": ["Hans", "Marlene"],
      "it-IT": ["Alice", "Luca"],
    };

    let excludedVoices = [];
    let voiceRSSApiKey = null;    // Will store the fetched API key
    let fallbackAudio = null;     // Will hold the <audio> element if using fallback

    /* -----------------------------------------------------------
       EXCLUDED VOICES
       ----------------------------------------------------------- */
    function updateExcludedVoices(newExclusions) {
      excludedVoices = newExclusions;
    }
    updateExcludedVoices(["Jester","Organ","Bubbles","Bad News","Boing","Wobble","Grandma","Grandpa","Rocko","Shelley","Flo","Eddy","Reed"]);

    /* -----------------------------------------------------------
       LOAD API KEY (for VoiceRSS fallback)
       ----------------------------------------------------------- */
    function loadApiKey() {
      // Fetch from api_key.json
      return fetch("api_key.json")
        .then(response => {
          if (!response.ok) {
            throw new Error("Failed to load api_key.json");
          }
          return response.json();
        })
        .then(data => {
          // Expecting { "VoiceRSS_API_Key": "YOUR_API_KEY" }
          if (!data.VoiceRSS_API_Key) {
            throw new Error("VoiceRSS_API_Key not found in api_key.json");
          }
          voiceRSSApiKey = data.VoiceRSS_API_Key;
        })
        .catch(error => {
          console.error("Error loading API key:", error);
          voiceRSSApiKey = null;
        });
    }

    /* -----------------------------------------------------------
       FILLING THE DROPDOWN WITH VOICES
       ----------------------------------------------------------- */
    function precomputeVoiceFilters(selectedLanguage) {
      const prioritizedVoices = regionalVoicePriority[selectedLanguage + "-US"] || [];
      const filteredVoices = {
        prioritized: [],
        fallback: []
      };

      voices.forEach((voice, index) => {
        if (excludedVoices.some(excluded => voice.name.includes(excluded))) {
          return;
        }
        if (prioritizedVoices.includes(voice.name)) {
          filteredVoices.prioritized.push({
            index,
            html: `<option value="${index}" selected>🌟 ${voice.name} (${voice.lang})</option>`
          });
        } else if (voice.lang.startsWith(selectedLanguage)) {
          filteredVoices.fallback.push({
            index,
            html: `<option value="${index}">${voice.name} (${voice.lang})</option>`
          });
        }
      });

      return filteredVoices;
    }

    function filterVoicesByLanguage() {
      const selectedLanguage = languageDropdown.value;
      const { prioritized, fallback } = precomputeVoiceFilters(selectedLanguage);
      voicesDropdown.innerHTML = `<option value="-1">Default Voice (Fallback)</option>` +
        prioritized.map(v => v.html).join('') +
        fallback.map(v => v.html).join('');
    }

    /* -----------------------------------------------------------
       TEXT DISPLAY & HIGHLIGHTING
       ----------------------------------------------------------- */
    function updateTextDisplay() {
      const text = textInput.value;
      if (text !== previousText) {
        const words = text.split(/(\s+)/);
        textDisplay.innerHTML = words
          .map((word, index) => `<span data-index="${index}">${word}</span>`)
          .join('');
        textDisplay.style.display = 'block';
        previousText = text;
        cachedSpans = textDisplay.querySelectorAll('span'); // Cache spans
        attachClickHandlers();
      }
    }

    function attachClickHandlers() {
      cachedSpans.forEach(span => {
        span.addEventListener('click', () => {
          const index = parseInt(span.getAttribute('data-index'), 10);
          startWordIndex = index;
          if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
          }
          highlightWord(index); // Immediately highlight selected word
          startReading(false);
        });
      });
    }

    function highlightWord(index) {
      cachedSpans.forEach(span => span.classList.remove('highlight'));
      if (cachedSpans[index]) {
        cachedSpans[index].classList.add('highlight');
      }
    }

    /* -----------------------------------------------------------
       PROGRESS & TIMING
       ----------------------------------------------------------- */
    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
      const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
      const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${hrs}:${mins}:${secs}`;
    }

    function updateProgress(currentWordIndex, totalWords) {
      const percent = Math.round((currentWordIndex / totalWords) * 100);
      progressPercent.textContent = `${percent}%`;
      const elapsedTime = Math.floor((Date.now() - readingStartTime) / 1000);
      // Estimate each word ~0.5 second at rate=1, but it's rough
      const estimatedTime = Math.round((totalWords - currentWordIndex) * 0.5);
      timeElapsed.textContent = formatTime(elapsedTime);
      timeRemaining.textContent = formatTime(estimatedTime);
    }

    function resetProgress() {
      progressPercent.textContent = '0%';
      timeElapsed.textContent = '00:00:00';
      timeRemaining.textContent = '00:00:00';
    }

    /* -----------------------------------------------------------
       FALLBACK LOGIC WITH VoiceRSS
       ----------------------------------------------------------- */
    async function speakWithVoiceRSS(text, langCode, rate = 1) {
      // If no API key, we cannot proceed
      if (!voiceRSSApiKey) {
        alert("No local voices found, and the VoiceRSS API key is missing. Cannot speak the text.");
        return;
      }

      try {
        // Stop any existing audio
        if (fallbackAudio) {
          fallbackAudio.pause();
          fallbackAudio = null;
        }
        // Prepare rate (VoiceRSS doesn't let you set rate precisely like speechSynthesis; we approximate)
        // VoiceRSS has a speed range -5 (slowest) to +5 (fastest)
        // We'll map browser range [0.5..2] => [-5..+5]
        const mappedRate = Math.round(((rate - 0.5) / 1.5) * 10 - 5);
        
        // Build request URL for VoiceRSS
        const apiUrl = `https://api.voicerss.org/?key=${encodeURIComponent(voiceRSSApiKey)}`
          + `&hl=${encodeURIComponent(langCode)}`
          + `&r=${mappedRate}`
          + `&c=MP3`
          + `&f=44khz_16bit_stereo`
          + `&src=${encodeURIComponent(text)}`;

        // Fetch the MP3 file
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error("VoiceRSS request failed");
        }
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);

        // Create audio element and play
        fallbackAudio = new Audio(blobUrl);
        fallbackAudio.play();

        // Since fallback doesn't do per-word boundary, we won't highlight words
        // We at least start a basic timer for total progress
        readingStartTime = Date.now();

        fallbackAudio.onended = () => {
          resetProgress();
        };

        // Basic progress timer
        const totalWords = text.split(/\s+/).length;
        const intervalId = setInterval(() => {
          if (!fallbackAudio || fallbackAudio.paused) {
            clearInterval(intervalId);
          }
          const elapsedSec = (Date.now() - readingStartTime) / 1000;
          // Rough guess: 0.5s per word
          const currentWordIndex = Math.min(Math.floor(elapsedSec / 0.5), totalWords);
          updateProgress(currentWordIndex, totalWords);
          if (fallbackAudio && fallbackAudio.ended) {
            clearInterval(intervalId);
          }
        }, 500);

      } catch (error) {
        console.error("Error in speakWithVoiceRSS:", error);
        alert("Failed to use VoiceRSS fallback. Check console for details.");
      }
    }

    /* -----------------------------------------------------------
       CONTROLS
       ----------------------------------------------------------- */
    function updateRate(rate) {
      rateValue.textContent = rate;
    }

    function pauseReading() {
      // If using native TTS
      if (speechSynthesis.speaking && !speechSynthesis.paused) {
        speechSynthesis.pause();
      }
      // If using fallback
      if (fallbackAudio && !fallbackAudio.paused) {
        fallbackAudio.pause();
      }
    }

    function resumeReading() {
      // If using native TTS
      if (speechSynthesis.paused) {
        speechSynthesis.resume();
      }
      // If using fallback
      if (fallbackAudio && fallbackAudio.paused) {
        fallbackAudio.play();
      }
    }

    function stopReading() {
      // If using native TTS
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        cachedSpans.forEach(span => span.classList.remove('highlight'));
      }
      // If using fallback
      if (fallbackAudio) {
        fallbackAudio.pause();
        fallbackAudio = null;
      }
      resetProgress();
    }

    /* -----------------------------------------------------------
       START READING (Primary function)
       ----------------------------------------------------------- */
    function startReading(reset = false) {
      const text = textInput.value.trim();
      if (!text) {
        alert('Please enter some text to read aloud.');
        return;
      }

      // Stop any current speech or fallback
      stopReading();
      if (reset) {
        startWordIndex = 0;
        resetProgress();
      }

      // If we have local voices
      const selectedVoiceIndex = parseInt(voicesDropdown.value, 10);
      const localVoicesAvailable = (voices.length > 0);

      // Decide whether we use fallback
      const shouldUseFallback = useVoiceRSSFallback && (!localVoicesAvailable || selectedVoiceIndex === -1);

      // If fallback is chosen or needed
      if (shouldUseFallback) {
        // For the fallback, choose a language code. The dropdown values are simple: "en", "es", "fr", etc.
        const lang = languageDropdown.value;
        speakWithVoiceRSS(text, lang, parseFloat(rateControl.value));
        return;
      }

      // Otherwise use the built-in speech synthesis
      const words = text.split(/(\s+)/);
      const selectedText = words.slice(startWordIndex).join('');

      speechSynthesisUtterance = new SpeechSynthesisUtterance(selectedText);

      if (!isNaN(selectedVoiceIndex) && voices[selectedVoiceIndex]) {
        speechSynthesisUtterance.voice = voices[selectedVoiceIndex];
      }
      speechSynthesisUtterance.rate = parseFloat(rateControl.value);
      speechSynthesisUtterance.pitch = 1;

      const totalWords = words.length;
      readingStartTime = Date.now();

      speechSynthesisUtterance.onboundary = (event) => {
        // highlight word-by-word
        const charIndex = event.charIndex;
        let cumulativeCharCount = 0;
        for (let i = startWordIndex; i < cachedSpans.length; i++) {
          cumulativeCharCount += cachedSpans[i].textContent.length;
          if (cumulativeCharCount > charIndex) {
            highlightWord(i);
            updateProgress(i, totalWords);
            break;
          }
        }
      };

      speechSynthesisUtterance.onend = () => {
        cachedSpans.forEach(span => span.classList.remove('highlight'));
        resetProgress();
      };

      speechSynthesis.speak(speechSynthesisUtterance);
    }

    /* -----------------------------------------------------------
       POPULATE VOICES
       ----------------------------------------------------------- */
    function populateVoices() {
      function retryPopulateVoices(attempt = 0) {
        if (!('speechSynthesis' in window)) {
          alert('Text-to-speech is not supported in your browser. Please try a different browser.');
          return;
        }
        voices = speechSynthesis.getVoices();
        if (voices.length === 0 && attempt < 5) {
          // exponential backoff
          setTimeout(() => retryPopulateVoices(attempt + 1), 200 * Math.pow(2, attempt));
        } else if (voices.length === 0) {
          console.warn("No local voices found. A fallback will be used if enabled.");
        } else {
          filterVoicesByLanguage();
        }
      }
      retryPopulateVoices();
    }

    /* -----------------------------------------------------------
       EVENT LISTENERS & INIT
       ----------------------------------------------------------- */
    textInput.addEventListener('input', updateTextDisplay);
    speechSynthesis.addEventListener('voiceschanged', populateVoices);

    // 1. Load the API key (for fallback)
    loadApiKey().then(() => {
      // 2. Then populate voices
      populateVoices();
    });
  </script>
</body>
</html>
